<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css' rel='stylesheet' />
    <script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script type="text/javascript">
        var mapboxTiles = L.tileLayer('https://api.mapbox.com/styles/v1/aashrai/cizvgeeuj002m2spfndaxzflx/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYWFzaHJhaSIsImEiOiJjaXp2Z2N2NWswMTI2MzNuaDdtMHE3MHEyIn0.2Y4IHW4OXer-0xb8LtxuWA', {
            attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
        });

        var map = L.map('map', {
                "scrollWheelZoom": false,
                "zoomControl": false
            })
            .addLayer(mapboxTiles)
            .setView([47.635, -122.284], 13);

        /* Initialize the SVG layer */
        map._initPathRoot()

        /* We simply pick up the SVG from the map object */
        var svg = d3.select("#map").select("svg");
        var g = svg.append("g").attr("class", "leaflet-zoom-hide");
        var timeFormat = d3.time.format("%m/%d/%Y %H:%M");

        d3.csv("station.csv", function(d) {
            return {
                "name": d['name'],
                "point": map.latLngToLayerPoint(new L.LatLng(d["lat"], d["long"]))
            }
        }, function(data) {
            g.selectAll("circle").data(data).enter().append("circle")
                .attr("cx", function(d) {
                    return d['point'].x;
                }).attr("cy", function(d) {
                    return d['point'].y;
                }).attr("r", 2).style("fill", "orange")
        })

        d3.csv("trip_date_max.csv", function(d) {
            var obj = {
                "starttime": timeFormat.parse(d['starttime']),
                "endtime": timeFormat.parse(d["stoptime"]),
                "from_point": map.latLngToLayerPoint(new L.LatLng(d["from_station_lat"], d["from_station_long"])),
                "to_point": map.latLngToLayerPoint(new L.LatLng(d["to_station_lat"], d["to_station_long"])),
                "trip_id": d['trip_id']
            }
            return obj
        }, function(data) {
            line = d3.svg.line()
            g.selectAll("line").data(data).enter().append("path")
                .attr("d", function(d) {
                    return line([
                        [d["from_point"].x, d["from_point"].y],
                        [d["to_point"].x, d["to_point"].y]
                    ])
                })
                .attr("id", function(d){ return "line" + data.indexOf(d) })
                .style("opacity", "0")

            var timeExtent = d3.extent(data, function(d){
              return d['starttime']
            });
            var timeRangeFactor = (2*60*1000)/(24*60*60*1000)
            var timeDomain = [timeExtent[0], timeExtent[1]];
            var timeRangeHigh = Math.abs(timeExtent[1]-timeExtent[0])*timeRangeFactor
            var timeRange = d3.time.scale.utc().domain(timeDomain).range([0,timeRangeHigh]);

            var timeTicks = timeRange.ticks(d3.time.minute, 5)
            var timeText = svg.append("text").attr("x",20).attr("y",50);

            var progressBarWidth = 300;
            var progressControllerRange = d3.time.scale.utc().domain(timeDomain)
            .range([0,progressBarWidth]);
            var progressControllerTicks = progressControllerRange
            .ticks(d3.time.minute, 5);

            svg.append("rect").attr("x",20).attr("y",20)
            .attr("width",progressBarWidth)
            .attr("height",10).style("fill","orange")
            var progressController = svg.append("rect").attr("x",20).attr("y",15)
            .attr("width",10).attr("height",20).style("fill","gray");

            progressControllerTicks.forEach(function(d){
              progressController.transition().duration(300).delay(timeRange(d))
              .attr("transform","translate("+progressControllerRange(d)+")")
            })
            timeTicks.forEach(function(d){
              timeText.transition().duration(100)
              .delay(timeRange(d)).text(d)
            })

            data.forEach(function(d,i) {
                var totalLength = d3.select("#line" + i).node().getTotalLength();

                d3.select("#line" + i).attr("stroke-dasharray", totalLength + " " + totalLength)
                    .attr("stroke-dashoffset", totalLength)
                    .style("opacity", "1")
                    .style("stroke", "steelblue")
                    .transition()
                    .duration(1000)
                    .delay(timeRange(d['starttime']))
                    .ease("quad")
                    .attr("stroke-dashoffset", 0)
                    .style("stroke-width", 1)
                    .transition()
                    .duration(300)
                    .style("opacity", 0)
            })
        })
    </script>
</body>

</html>
